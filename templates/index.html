<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ui_config.ui_settings.app_title | default('My Personalized RAG Summarizer') }}</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Fallback for background color */
            {% if ui_config.ui_settings.background.type == 'image' and ui_config.ui_settings.background.value %}
            background-image: url('{{ ui_config.ui_settings.background.value }}');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            {% elif ui_config.ui_settings.background.type == 'local_image' and ui_config.ui_settings.background.value %}
            /* Assuming local images are in a 'static' folder, e.g., static/images/terminal1.png */
            background-image: url('{{ url_for('static', filename=ui_config.ui_settings.background.value) }}');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            {% elif ui_config.ui_settings.background.type == 'color' and ui_config.ui_settings.background.value %}
            background-color: {{ ui_config.ui_settings.background.value }};
            {% endif %}
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            /* Padding from body is now handled by px-4/10/20 and py-4 on body itself */
        }

        /* Common window styling */
        .rag-window {
            background-color: {{ ui_config.ui_settings.windows.common.background_color_fallback | default('rgba(0, 0, 0, 0.7)') }};
            border-radius: {{ ui_config.ui_settings.windows.common.border_radius | default('10px') }};
            padding: {{ ui_config.ui_settings.windows.common.padding | default('20px') }};
            opacity: {{ ui_config.ui_settings.windows.common.opacity | default('0.85') }};
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            display: flex; /* Ensure flex for internal content alignment */
            flex-direction: column; /* Stack children vertically */
        }

        /* Specific window styling overrides */
        #input-window {
            color: {{ ui_config.ui_settings.windows.input_window.text_color | default('#FFFFFF') }};
        }
        #query-input::placeholder {
            color: {{ ui_config.ui_settings.windows.input_window.placeholder_color | default('rgba(255, 255, 255, 0.6)') }};
        }
        /* Target the inner content div for styling and scrolling */
        #llm-response-window .window-content { 
            color: {{ ui_config.ui_settings.windows.llm_response_window.text_color | default('#E0FFFF') }};
            font-size: {{ ui_config.ui_settings.windows.llm_response_window.font_size | default('16px') }};
            line-height: {{ ui_config.ui_settings.windows.llm_response_window.line_height | default('1.6') }};
        }
        #references-window .window-content { 
            color: {{ ui_config.ui_settings.windows.references_window.text_color | default('#ADD8E6') }};
            font-size: {{ ui_config.ui_settings.windows.references_window.font_size | default('14px') }};
            line-height: {{ ui_config.ui_settings.windows.references_window.line_height | default('1.4') }};
        }

        /* Custom scrollbar for content windows */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen px-4 lg:px-10 xl:px-20 py-4">

    <!-- Initialization Progress Bar -->
    <div id="initialization-status" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
            <p id="progress-text" class="text-xl font-semibold text-white mb-4">Initializing RAG System...</p>
            <div class="w-full bg-gray-700 rounded-full h-3">
                <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
            </div>
            <p class="text-sm text-gray-400 mt-2">Please wait while the AI backend loads.</p>
        </div>
    </div>

    <!-- Main Application Content (Initially Hidden) -->
    <div id="main-app-content" class="container mx-auto flex flex-col gap-6 w-full max-w-7xl h-[calc(100vh-32px)]" style="display: none;">
        <!-- Application Title -->
        <h1 class="text-5xl font-extrabold text-white text-center mb-6">
            {{ ui_config.ui_settings.app_title | default('My Personalized RAG Summarizer') }}
        </h1>

        <!-- Input Window -->
        <div id="input-window" class="rag-window flex-shrink-0">
            <h2 class="text-2xl font-bold mb-4 text-orange-400">Ask Your Documents</h2>
            <textarea id="query-input"
                      class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 resize-y text-white custom-scrollbar"
                      rows="4"
                      placeholder="e.g., MISC:LEGAL: how much stock does Concely del Carmen Mendez Rojas supposedly own in Visa Stock?"></textarea>
            <button id="submit-query"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Submit Query
            </button>
        </div>

        <!-- Response and References Container -->
        <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
            <!-- LLM Response Window -->
            <div id="llm-response-window" class="rag-window flex-grow min-h-0">
                <h2 class="text-2xl font-bold mb-4 text-sky-400">LLM Response</h2>
                <div id="llm-response-content" class="window-content flex-grow text-gray-200 whitespace-pre-wrap overflow-auto custom-scrollbar">
                    Your AI assistant's response will appear here.
                </div>
            </div>

            <!-- References Window -->
            <div id="references-window" class="rag-window flex-grow min-h-0">
                <h2 class="text-2xl font-bold mb-4 text-blue-300">References</h2>
                <div id="references-content" class="window-content flex-grow text-gray-300 overflow-auto custom-scrollbar">
                    Sources will be listed here.
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const initStatusDiv = document.getElementById('initialization-status');
            const progressText = document.getElementById('progress-text');
            const progressBar = document.getElementById('progress-bar');
            const mainAppContent = document.getElementById('main-app-content');
            const queryInput = document.getElementById('query-input');
            const submitQueryButton = document.getElementById('submit-query');
            const llmResponseContent = document.getElementById('llm-response-content');
            const referencesContent = document.getElementById('references-content');

            // Show initialization status initially
            if (initStatusDiv) {
                initStatusDiv.style.display = 'flex';
            }

            const eventSource = new EventSource('/stream_init_status');

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log("Received init status:", data);

                if (data.type === 'init_progress') {
                    if (progressText) progressText.textContent = data.stage;
                    if (progressBar) progressBar.style.width = data.percentage + '%';
                } else if (data.type === 'init_complete') {
                    if (data.success) {
                        if (progressText) progressText.textContent = 'RAG System Ready! âœ¨';
                        if (progressBar) {
                            progressBar.style.width = '100%';
                            progressBar.classList.remove('bg-blue-500');
                            progressBar.classList.add('bg-green-500'); // Indicate success
                        }
                        setTimeout(() => {
                            if (initStatusDiv) initStatusDiv.style.display = 'none'; // Hide after a delay
                            if (mainAppContent) mainAppContent.style.display = 'flex'; // Show main app content as flex column
                            queryInput.focus(); // Focus on the input field
                        }, 1500);
                    } else {
                        if (progressText) progressText.textContent = `Initialization Failed: ${data.error || 'Unknown error'}`;
                        if (progressBar) {
                            progressBar.style.width = '100%';
                            progressBar.classList.remove('bg-blue-500');
                            progressBar.classList.add('bg-red-500'); // Indicate failure
                        }
                        // Keep the error message visible for longer or indefinitely
                    }
                    eventSource.close(); // Close the connection
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                if (progressText) progressText.textContent = 'Connection to server lost. Please check server logs.';
                if (progressBar) {
                    progressBar.classList.remove('bg-blue-500');
                    progressBar.classList.add('bg-red-500');
                }
                eventSource.close();
            };

            // --- Query Submission Logic ---
            submitQueryButton.addEventListener('click', submitQuery);
            queryInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { // Submit on Enter, not Shift+Enter
                    e.preventDefault(); // Prevent new line in textarea
                    submitQuery();
                }
            });

            function submitQuery() {
                const query = queryInput.value.trim();
                if (!query) {
                    alert('Please enter a query.'); // Consider a custom modal instead of alert
                    return;
                }

                llmResponseContent.textContent = 'Thinking...';
                referencesContent.innerHTML = 'Retrieving sources...';
                submitQueryButton.disabled = true; // Disable button during processing

                fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        llmResponseContent.textContent = `Error: ${data.error}`;
                        referencesContent.innerHTML = '';
                        submitQueryButton.disabled = false;
                        return;
                    }
                    // Start streaming the response
                    const responseEventSource = new EventSource('/stream_response');
                    let fullResponse = '';
                    let citations = [];
                    let referencedArticles = [];

                    llmResponseContent.textContent = ''; // Clear initial "Thinking..."

                    responseEventSource.onmessage = function(event) {
                        const streamData = JSON.parse(event.data);
                        if (streamData.type === 'llm_chunk') {
                            fullResponse += streamData.content;
                            llmResponseContent.textContent = fullResponse;
                            // Scroll to bottom
                            llmResponseContent.scrollTop = llmResponseContent.scrollHeight;
                        } else if (streamData.type === 'end_stream') {
                            citations = streamData.results.citations;
                            referencedArticles = streamData.results.referenced_articles;
                            displayReferences(citations, referencedArticles);
                            submitQueryButton.disabled = false;
                            responseEventSource.close();
                        }
                    };

                    responseEventSource.onerror = function(err) {
                        console.error("Response EventSource failed:", err);
                        llmResponseContent.textContent = `Error streaming response: ${err.message || 'Connection lost.'}`;
                        submitQueryButton.disabled = false;
                        responseEventSource.close();
                    };
                })
                .catch(error => {
                    console.error('Error submitting query:', error);
                    llmResponseContent.textContent = `Error: ${error.message || 'Failed to submit query.'}`;
                    submitQueryButton.disabled = false;
                });
            }

            function displayReferences(citations, referencedArticles) {
                referencesContent.innerHTML = ''; // Clear previous references
                if (citations && citations.length > 0) {
                    const citationsHtml = citations.map((doc, index) => {
                        const source = doc.metadata.source || 'Unknown Source';
                        const title = doc.metadata.original_title || doc.metadata.title || 'No Title';
                        const category = doc.metadata.category || 'N/A';
                        const snippet = doc.page_content ? doc.page_content.substring(0, 200) + '...' : 'No snippet available.';
                        return `
                            <div class="mb-3 p-2 bg-gray-700 rounded-md">
                                <p class="font-semibold text-blue-200">Source ${index + 1}: ${source}</p>
                                <p class="text-sm text-gray-400">Category: ${category}</p>
                                <p class="text-sm text-gray-400">Title: ${title}</p>
                                <p class="text-xs text-gray-500">Snippet: ${snippet}</p>
                            </div>
                        `;
                    }).join('');
                    referencesContent.innerHTML += `<h3 class="text-xl font-bold mb-2 text-blue-300">Citations:</h3>${citationsHtml}`;
                }

                if (referencedArticles && referencedArticles.length > 0) {
                    const articlesHtml = referencedArticles.map((article, index) => {
                        return `
                            <div class="mb-3 p-2 bg-gray-700 rounded-md">
                                <p class="font-semibold text-blue-200">Article ${index + 1}: ${article.title}</p>
                                <p class="text-sm text-gray-400">Site: ${article.site_origin}</p>
                                <p class="text-xs text-gray-500">Summary: ${article.summary.substring(0, 200)}...</p>
                            </div>
                        `;
                    }).join('');
                    referencesContent.innerHTML += `<h3 class="xl font-bold mt-4 mb-2 text-blue-300">Referenced Articles:</h3>${articlesHtml}`;
                }

                if (citations.length === 0 && referencedArticles.length === 0) {
                    referencesContent.innerHTML = '<p class="text-gray-400">No specific references found for this query.</p>';
                }
            }
        });
    </script>
</body>
</html>

